machine:
  services:
    - docker

general:
  artifacts:
    - linter.html

dependencies:
  override:
    - make submodules
    - docker pull fedora:22
    - pip install 'docker-compose<1.3'

test:
  override:
    - docker build -t spacewiki_app .
    - docker run -v `pwd`:/srv/spacewiki/ spacewiki_app make docker_test
    - docker run -v `pwd`:/srv/spacewiki/ spacewiki_app make lint
    - docker run -d -p 5000:5000 spacewiki_app
    - sleep 5
    - curl http://localhost:5000/
    - docker login -u $DOCKER_USERNAME -e $DOCKER_EMAIL -p $DOCKER_PASSWORD
    - docker tag spacewiki_app tdfischer/spacewiki
    - docker push tdfischer/spacewiki
deployment:
  ratchet:
    branch: master
    commands:
      - ansible-playbook -i deploy/hosts.txt deploy/ratchet.yml -u spacewiki-deploy
